generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  SALESMAN
  ADMIN
  SUPER_ADMIN
}

enum OrderSource {
  WEBSITE
  SHOWROOM
  WHOLESALE
  MANUAL
}

enum SaleType {
  SINGLE
  BULK
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCEL
  RETURNED
}

enum ExpenseStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELED
}

enum CartItemStatus {
  IN_CART
  ORDERED
  SOLD
}

enum Gender {
  MEN
  WOMEN
  UNISEX
  BOYS
  GIRLS
}

enum ClothingSize {
  XXS
  XS
  S
  M
  L
  XL
  XXL
  XXXL
  CUSTOM
}

enum FitType {
  SLIM
  REGULAR
  RELAXED
  OVERSIZED
  TAILORED
}

model User {
  id                      String    @id @default(auto()) @map("_id") @db.ObjectId
  name                    String
  email                   String    @unique
  password                String?
  imageUrl                String?
  phone                   String?
  address                 String?
  role                    Role      @default(USER)
  isVerified              Boolean   @default(false)
  resetToken              String?
  resetTokenExpiry        DateTime?
  verificationToken       String?
  verificationTokenExpiry DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  Blog           Blog[]
  Review         Review[]
  orderItems     CartItem[]
  wishlist       Wishlist[]
  Expense        Expense[]
  customerOrders Order[]         @relation("CustomerOrders")
  salesmanOrders Order[]         @relation("SalesmanOrders")
  comboWishlists ComboWishlist[]

  @@map("users")
}

model Category {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  categoryName String    @unique
  imageUrl     String?
  description  String?
  sizes        String[]
  published    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  Product      Product[]

  @@map("categories")
}

model Collection {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  collectionName String    @unique
  imageUrl       String?
  description    String?
  season         String? // e.g., "Spring 2024", "Winter Collection"
  published      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  Product        Product[]

  @@map("collections")
}

model Fabric {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  fabricName  String   @unique
  imageUrl    String?
  description String?
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ProductFabric ProductFabric[]

  @@map("fabrics")
}

model Material {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  materialName String   @unique
  imageUrl     String?
  published    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ProductMaterial ProductMaterial[]

  @@map("materials")
}

// model Color {
//   id        String   @id @default(auto()) @map("_id") @db.ObjectId
//   colorName String   @unique
//   hexCode   String? // e.g., "#FF5733"
//   imageUrl  String? // optional swatch image
//   published Boolean  @default(false)
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   ProductVariant ProductVariant[]

//   @@map("colors")
// }

model Product {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  slug         String   @unique
  description  String
  primaryImage String
  otherImages  String[]
  videoUrl     String?
  tags         String[]
  salesCount   Int      @default(0)
  published    Boolean  @default(false)

  // Apparel specifications
  brand            String?
  gender           Gender?
  fitType          FitType?
  pattern          String? // e.g., "Solid", "Striped", "Floral"
  neckline         String? // e.g., "Round", "V-neck", "Collar"
  sleeveType       String? // e.g., "Full Sleeve", "Half Sleeve", "Sleeveless"
  occasion         String[] // e.g., ["Casual", "Formal", "Party"]
  careInstructions String? // washing and care details
  madeIn           String? // country of origin

  categoryId String   @db.ObjectId
  category   Category @relation(fields: [categoryId], references: [id])

  collectionId String?     @db.ObjectId
  collection   Collection? @relation(fields: [collectionId], references: [id])

  ProductFabric ProductFabric[]

  ProductMaterial ProductMaterial[]

  // Variants (different sizes and colors with individual stock)
  variants ProductVariant[]

  supplier String?

  // Remove stock from product level - now only in variants
  stocklogs StockLog[]

  // Discounts (can be applied per product)
  discounts Discount[]

  // Reviews
  Review Review[]

  orderItems    CartItem[]
  wishlist      Wishlist[]
  comboVariants ComboVariant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

// Junction table for product fabrics
model ProductFabric {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  productId String @db.ObjectId
  fabricId  String @db.ObjectId

  product Product @relation(fields: [productId], references: [id])
  fabric  Fabric  @relation(fields: [fabricId], references: [id])

  @@unique([productId, fabricId])
  @@map("product_fabrics")
}

model ProductMaterial {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  productId  String @db.ObjectId
  materialId String @db.ObjectId

  product  Product  @relation(fields: [productId], references: [id])
  material Material @relation(fields: [materialId], references: [id])

  @@unique([productId, materialId])
  @@map("product_materials")
}

model ProductVariant {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  productId String @db.ObjectId
  sku       String @unique

  // Size and color
  size    ClothingSize
  color   String

  // Pricing
  price          Float
  costPrice      Float? // for profit calculation

  // Stock management (per variant)
  stock             Int  @default(0) // quantity in stock

  // Variant-specific details
  images  String[] @default([]) // variant-specific images

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])

  orderItems    CartItem[]
  stocklogs     StockLog[]
  comboVariants ComboVariant[]

  // Discounts (can be applied per variant)
  discounts Discount[]

  @@map("product_variants")
}

model ComboProduct {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  slug           String   @unique
  description    String?
  primaryImage   String
  otherImages    String[]
  price          Float // combo price (usually discounted)
  compareAtPrice Float? // sum of individual prices
  published      Boolean  @default(false)
  tags           String[]
  salesCount     Int      @default(0)

  // Combo-specific
  validFrom   DateTime?
  validUntil  DateTime?
  maxQuantity Int?      @default(100) // limit combo purchases

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variants      ComboVariant[]
  comboOrders   ComboOrderItem[]
  comboWishlist ComboWishlist[]

  @@map("combo_products")
}

model ComboVariant {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  comboId   String @db.ObjectId
  productId String @db.ObjectId
  variantId String @db.ObjectId
  quantity  Int    @default(1) // how many of this variant in the combo

  combo   ComboProduct   @relation(fields: [comboId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([comboId, variantId]) // same variant can't be in combo twice
  @@map("combo_variants")
}

model ComboOrderItem {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  orderId  String @db.ObjectId
  comboId  String @db.ObjectId
  quantity Int
  price    Float // price at time of purchase

  order Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  combo ComboProduct @relation(fields: [comboId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("combo_order_items")
}

model ComboWishlist {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  comboId   String       @db.ObjectId
  userId    String       @db.ObjectId
  user      User         @relation(fields: [userId], references: [id])
  combo     ComboProduct @relation(fields: [comboId], references: [id])
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([comboId, userId])
  @@map("combo_wishlist_items")
}

model Order {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  invoice     String      @unique
  orderTime   DateTime    @default(now())
  amount      Float
  isPaid      Boolean
  method      String?
  cartItems   Json?
  status      OrderStatus @default(PENDING)
  orderSource OrderSource
  productIds  String[]

  // Website orders
  customerId String? @db.ObjectId
  customer   User?   @relation("CustomerOrders", fields: [customerId], references: [id])

  shippingCost    Float   @default(0)
  trackingNumber  String? // shipping tracking
  additionalNotes String?
  shipping        Json?
  billing         Json?

  // Manual sales
  salesmanId String?   @db.ObjectId
  salesman   User?     @relation("SalesmanOrders", fields: [salesmanId], references: [id])
  saleType   SaleType?

  // Optional walk-in customer info
  name    String?
  phone   String?
  email   String?
  address String?

  // Relation to CartItem
  orderItems CartItem[] @relation("Order_CartItems")

  comboOrderItem ComboOrderItem[]

  payments       Payment[]
  orderDiscounts OrderDiscount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("orders")
}

model CartItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  userId    String? @db.ObjectId
  productId String  @db.ObjectId
  variantId String  @db.ObjectId // Required for apparel
  quantity  Int
  price     Float

  status CartItemStatus @default(IN_CART)

  // Relations
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])
  user    User?          @relation(fields: [userId], references: [id])

  orderId String? @db.ObjectId
  order   Order?  @relation("Order_CartItems", fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cart_items")
}

model StockLog {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  productId String         @db.ObjectId
  variantId String         @db.ObjectId // Required - stock is always per variant
  product   Product        @relation(fields: [productId], references: [id])
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  change    Int // +10 (restock), -2 (sold), etc.
  reason    String // e.g. SALE, RETURN, ADJUSTMENT, DAMAGED, RESTOCK
  notes     String? // additional context
  createdAt DateTime       @default(now())

  @@map("stock_logs")
}

model Payment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String   @db.ObjectId
  amount        Float
  method        String
  status        String
  transactionId String? // payment gateway transaction ID
  createdAt     DateTime @default(now())
  order         Order    @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model Discount {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  productId         String?   @db.ObjectId // null means site-wide discount
  variantId         String?   @db.ObjectId
  code              String?   @unique
  name              String? // display name for discount
  type              String // "percentage" | "fixed" | "buy_x_get_y"
  value             Float
  minPurchaseAmount Float? // minimum order value
  maxUsage          Int? // total usage limit
  maxUsagePerUser   Int? // per-user limit
  startDate         DateTime?
  endDate           DateTime?
  isActive          Boolean   @default(true)

  product Product?        @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  OrderDiscount OrderDiscount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("discounts")
}

model OrderDiscount {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId    String   @db.ObjectId
  discountId String   @db.ObjectId
  order      Order    @relation(fields: [orderId], references: [id])
  discount   Discount @relation(fields: [discountId], references: [id])
}

model Expense {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  expenseTime DateTime      @default(now())
  amount      Float
  method      String
  isPaid      Boolean
  title       String?
  description String?
  reference   String?
  status      ExpenseStatus @default(PENDING)

  expenseById String? @db.ObjectId
  expenseBy   User?   @relation(fields: [expenseById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("expenses")
}

model Blog {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  content         String
  imageUrl        String?
  imageAltText    String?
  others          String?
  isPublish       Boolean  @default(false)
  userId          String   @db.ObjectId
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  metaTitle       String?
  metaDescription String?
  keywords        String?
  slug            String   @unique

  user User @relation(fields: [userId], references: [id])

  @@map("blogs")
}

model Review {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  rating      Int
  title       String
  comment     String
  isPublished Boolean @default(false)
  productId   String  @db.ObjectId
  userId      String? @db.ObjectId

  product Product @relation(fields: [productId], references: [id])
  user    User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reviews")
}

model Wishlist {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  productId String   @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("wishlist_items")
}
